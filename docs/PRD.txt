Atue como um Engenheiro de Software Sênior (Tech Lead) especialista em Next.js 16, Supabase e Fintech.

Estamos migrando o projeto "AgentiVerso" de Mercado Pago para **Appmax** e transformando-o em um **PWA**.
Eu já forneci o schema atual do banco de dados. NÃO apague tabelas existentes. Apenas altere o necessário.

Siga este plano de execução sequencial:

### FASE 1: CLEANUP (Remoção do Mercado Pago) ✅
1.  Desinstale o pacote `mercadopago`: `npm uninstall mercadopago`.
2.  Exclua o arquivo de webhook antigo: `rm app/api/webhooks/mercadopago/route.ts`.
3.  Limpe o conteúdo de `app/api/checkout/route.ts` (vamos reescrever do zero).

---

### FASE 2: BANCO DE DADOS (Supabase SQL) ✅

#### 2.1 Preparação para Appmax e 1-Click Upsell
```sql
ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS appmax_customer_id text,
ADD COLUMN IF NOT EXISTS last_payment_token text,
ADD COLUMN IF NOT EXISTS last_payment_brand text;

ALTER TABLE transactions
ADD COLUMN IF NOT EXISTS appmax_order_id text,
ADD COLUMN IF NOT EXISTS payment_method text;
```

#### 2.2 Sistema de Monetização Híbrida (NOVO)
```sql
-- Campos de monetização nos agentes
ALTER TABLE agents 
ADD COLUMN IF NOT EXISTS is_free BOOLEAN DEFAULT true,
ADD COLUMN IF NOT EXISTS price DECIMAL(10,2) DEFAULT 0,
ADD COLUMN IF NOT EXISTS bonus_credits INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS is_featured BOOLEAN DEFAULT false;

-- Controle de acesso premium
CREATE TABLE IF NOT EXISTS user_agent_access (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    agent_id UUID NOT NULL REFERENCES agents(id) ON DELETE CASCADE,
    purchased_at TIMESTAMPTZ DEFAULT NOW(),
    transaction_id UUID REFERENCES transactions(id),
    UNIQUE(user_id, agent_id)
);

-- Combos promocionais
CREATE TABLE IF NOT EXISTS agent_combos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    original_price DECIMAL(10,2),
    bonus_credits INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    valid_until TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS combo_agents (
    combo_id UUID NOT NULL REFERENCES agent_combos(id) ON DELETE CASCADE,
    agent_id UUID NOT NULL REFERENCES agents(id) ON DELETE CASCADE,
    PRIMARY KEY (combo_id, agent_id)
);

-- Suporte a tipos de transação
ALTER TABLE transactions
ADD COLUMN IF NOT EXISTS type TEXT DEFAULT 'credits',
ADD COLUMN IF NOT EXISTS agent_id UUID REFERENCES agents(id),
ADD COLUMN IF NOT EXISTS combo_id UUID REFERENCES agent_combos(id);
```

---

### FASE 3: BACKEND & INTEGRAÇÃO APPMAX ✅

Arquivo `lib/appmax.ts` criado com:
- OAuth2 authentication
- Endpoints: customers, orders, payments (PIX)
- Ambiente sandbox/produção configurável

**Variáveis de ambiente necessárias:**
- `APPMAX_CLIENT_ID`
- `APPMAX_CLIENT_SECRET`
- `APPMAX_SANDBOX` (true/false)

---

### FASE 4: TRANSFORMAÇÃO PWA ✅

Implementado com service worker vanilla:
- `public/sw.js` - Service worker básico
- `public/manifest.json` - Configuração PWA
- `components/service-worker-registration.tsx` - Registro do SW

---

### FASE 5: UI REDESIGN FUTURISTA ✅

Componentes criados:
- `Sidebar` - Navegação lateral colapsável
- `CreditCounter` - Contador animado de créditos
- `AgentAvatar` - Avatar com status e modo locked
- `CategoryFilter` - Filtro de categorias funcional
- `DashboardContent` - Dashboard com agentes bloqueados

Estilo:
- Tema Cyberpunk com cores neon (cyan/pink)
- Scrollbar customizado
- Animações (scan-line, gradient-x, glow-pulse)

---

### FASE 6: SISTEMA DE MONETIZAÇÃO ✅ (Fase 1 concluída)

**Admin atualizado:**
- `/admin/agents/[id]` - Campos: is_free, price, bonus_credits, is_public, is_featured
- `/admin/agents/new` - Mesmos campos para novos agentes
- `/admin/combos` - CRUD completo de combos promocionais

**Dashboard:**
- Agentes premium aparecem com cadeado (grayscale)
- Botão "Desbloquear Acesso" redireciona para compra

**Próximos passos (Fase 2):**
- [ ] Backend de compra de agente (`/api/checkout` type='agent')
- [ ] Webhook libera acesso e credita bônus
- [ ] Modal de compra de agente no dashboard

---

### CHECKLIST DE FINALIZAÇÃO

* [x] O código trata erros de API da Appmax (try/catch).
* [x] O Webhook retorna status 200 rápido.
* [x] Variáveis de ambiente configuráveis.
* [x] Login/Signup redirect funcionando.
* [x] UI futurista implementada.
* [x] Admin com campos de monetização.
* [ ] Compra de agente premium funcionando.
* [ ] Compra de combo funcionando.